<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Doge Görev & Kazan</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome (İkonlar için) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <!-- Google Font: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Doge Sarı/Beyaz Tema */
        :root {
            --doge-yellow: #F7931A; /* Dogecoin Sarı */
            --light-yellow: #FFFBEA;
            --doge-text: #1C1C1E;
            --bg-color: #f7f7f7;
        }

        /* Temel Stiller ve Yazı Tipi */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--doge-text);
            overscroll-behavior: none;
        }
        .main-container {
            max-width: 420px;
            margin: 0 auto;
            min-height: 100vh;
            background-color: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
            position: relative;
        }

        /* Sayfa İçerik Alanı */
        .page-content {
            padding: 16px;
            padding-top: 60px; /* Header'ı telafi etmek için */
            display: none;
            min-height: calc(100vh - 56px); /* Alt navı saymazsak */
        }
        .page-content.active {
            display: block;
        }

        /* Başlık Çubuğu */
        .header {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            max-width: 420px;
            width: 100%;
            background-color: white;
            border-bottom: 1px solid #eee;
            z-index: 10;
        }

        /* Buton Stilleri */
        .doge-btn {
            background-color: var(--doge-yellow);
            color: white;
            font-weight: 700;
            transition: all 0.2s;
            box-shadow: 0 4px 6px -1px rgba(247, 147, 26, 0.4);
        }
        .doge-btn:hover {
            filter: brightness(0.9);
            box-shadow: 0 6px 8px -1px rgba(247, 147, 26, 0.5);
        }

        /* Yan Menü (Drawer) Stilleri */
        .drawer {
            position: fixed;
            top: 0;
            left: 0;
            width: 80%;
            max-width: 300px;
            height: 100%;
            background-color: white;
            z-index: 50;
            transform: translateX(-100%);
            transition: transform 0.3s ease-out;
            box-shadow: 4px 0 10px rgba(0,0,0,0.1);
        }
        .drawer.open {
            transform: translateX(0);
        }
        .drawer-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 40;
            display: none;
        }
        .drawer-overlay.open {
            display: block;
        }
        .menu-item {
            padding: 1rem;
            display: flex;
            align-items: center;
            font-size: 1.1rem;
            color: var(--doge-text);
            cursor: pointer;
            transition: background-color 0.15s;
        }
        .menu-item:hover {
            background-color: #f5f5f5;
        }

        /* Loading Spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid var(--doge-yellow);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

<div class="main-container">

    <!-- Header / Yan Menü Butonu -->
    <header class="header flex justify-between items-center p-4">
        <button id="menu-toggle" class="text-xl p-2 rounded-full hover:bg-gray-100">
            <i class="fas fa-bars"></i>
        </button>
        <h1 class="text-xl font-bold">Doge Faucet</h1>
        <div id="loading-indicator" class="spinner" style="display:none;"></div>
    </header>

    <!-- Yan Menü (Drawer) -->
    <div id="drawer" class="drawer">
        <div class="p-4 border-b">
            <h2 class="text-2xl font-bold text-doge-yellow">Menü</h2>
            <p id="drawer-user-id" class="text-xs text-gray-500 mt-1 truncate">ID: Yükleniyor...</p>
        </div>
        
        <div class="flex flex-col p-2">
            <div class="menu-item" data-page="menu-page"><i class="fas fa-home w-6"></i><span class="ml-3">Ana Sayfa</span></div>
            <div class="menu-item" data-page="ad-view-page"><i class="fas fa-video w-6"></i><span class="ml-3">Reklam İzle (0.01 Ɖ)</span></div>
            <div class="menu-item" data-page="tasks-page"><i class="fas fa-list-check w-6"></i><span class="ml-3">Görevler (0.02 Ɖ)</span></div>
            <div class="menu-item" data-page="task-creation-page"><i class="fas fa-plus-circle w-6"></i><span class="ml-3">Görev Oluştur</span></div>
            <div class="menu-item" data-page="withdrawal-page"><i class="fas fa-wallet w-6"></i><span class="ml-3">Para Çekme</span></div>
            <div id="admin-menu-item" class="menu-item hidden" data-page="admin-panel"><i class="fas fa-user-shield w-6"></i><span class="ml-3">Admin Paneli</span></div>
        </div>
    </div>
    <div id="drawer-overlay" class="drawer-overlay"></div>

    <!-- Modallar ve Mesaj Alanı -->
    <div id="message-box" class="fixed top-16 left-1/2 transform -translate-x-1/2 bg-green-500 text-white p-3 rounded-lg shadow-xl z-50 transition-opacity duration-300 opacity-0 pointer-events-none">
        İşlem başarılı!
    </div>
    
    <!-- Sayfalar -->

    <!-- 1. Ana Menü (İstatistikler ve Airdrop) -->
    <div id="menu-page" class="page-content active">
        <h2 class="text-3xl font-extrabold mb-6 text-center text-doge-yellow">Doge Kazanmaya Başla!</h2>
        
        <!-- Bakiye Kartı -->
        <div class="bg-light-yellow p-4 rounded-xl shadow-md mb-6 border border-yellow-300">
            <p class="text-sm text-gray-700">Toplam Bakiyeniz</p>
            <p id="doge-balance" class="text-4xl font-bold mt-1">0.00 Ɖ</p>
            <p class="text-sm text-gray-500 mt-2">Kazanılan Toplam: <span id="total-earned">0.00 Ɖ</span></p>
            <p class="text-sm text-gray-500">İzlenen Reklam: <span id="total-ads">0</span> | Tamamlanan Görev: <span id="total-tasks">0</span></p>
        </div>

        <!-- Saatlik Airdrop Kartı -->
        <div class="bg-white p-4 rounded-xl shadow-md mb-6 border">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-bold">Saatlik Airdrop</h3>
                <i class="fas fa-gift text-2xl text-doge-yellow"></i>
            </div>
            <!-- GÜNCELLENDİ: Sabit ödül miktarını gösterir -->
            <p class="text-sm text-gray-600 mt-2">Her saat, katılanların %25'i rastgele kazanır. (Kazanan başına sabit ödül: 0.25 Ɖ)</p>
            <p id="airdrop-timer" class="text-lg font-mono mt-3 text-center text-red-600">Yeni Airdrop Başlıyor...</p>
            <p id="airdrop-participants" class="text-sm text-center text-gray-500">Katılımcı Sayısı: 0</p>
            <button id="join-airdrop-btn" class="doge-btn w-full py-3 rounded-full mt-4 text-lg" disabled>
                Airdrop'a Katıl
            </button>
        </div>
        
    </div>

    <!-- 2. Reklam İzleme Sayfası -->
    <div id="ad-view-page" class="page-content">
        <h2 class="text-2xl font-bold mb-4">Reklam İzle ve Kazan</h2>
        <div id="ad-area" class="bg-gray-200 h-48 flex items-center justify-center rounded-xl mb-4 text-gray-500 text-center p-4">
            Burada bir reklam alanı (video veya görsel) simüle edilmiştir.
            (Gerçek entegrasyon için bir reklam ağı SDK'sı gerekir)
        </div>
        <button id="view-ad-btn" class="doge-btn w-full py-3 rounded-xl text-lg">
            Reklamı İzle (0.01 Ɖ Kazan)
        </button>
        <p class="text-sm text-gray-500 mt-4">Reklamı izlediğinizde otomatik olarak 0.01 Doge bakiyenize eklenecektir.</p>
    </div>

    <!-- 3. Görevler Sayfası -->
    <div id="tasks-page" class="page-content">
        <h2 class="text-2xl font-bold mb-4">Mevcut Görevler</h2>
        <p class="text-sm text-gray-600 mb-4">Görev başına 0.02 Ɖ kazanma fırsatı!</p>
        <div id="current-tasks-list" class="space-y-3">
            <!-- Görevler buraya Firestore'dan yüklenecek -->
            <div class="task-card bg-white p-4 rounded-xl shadow border flex justify-between items-center">
                <div>
                    <p class="font-semibold text-lg">Telegram Kanalına Katıl</p>
                    <p class="text-sm text-gray-500">Ödül: 0.02 Ɖ | Kalan Kontenjan: 50</p>
                </div>
                <button class="doge-btn px-4 py-2 rounded-lg text-sm complete-task-btn" data-task-id="sample-1">Yap</button>
            </div>
        </div>
    </div>

    <!-- 4. Görev Oluşturma Sayfası (Reklam Verenler İçin) -->
    <div id="task-creation-page" class="page-content">
        <h2 class="text-2xl font-bold mb-4">Yeni Görev Oluştur</h2>
        <div class="bg-light-yellow p-4 rounded-xl shadow-inner mb-4 border border-yellow-300">
            <p class="text-sm font-semibold">Görev Maliyeti:</p>
            <p class="text-xl font-bold text-doge-yellow">Üye Başına 0.02 Ɖ</p>
            <p class="text-xs text-gray-600">Görevi tamamlayacak her bir kullanıcı için bakiyenizden 0.02 Ɖ düşülecektir.</p>
        </div>

        <form id="create-task-form" class="space-y-4">
            <div>
                <label for="task-title" class="block text-sm font-medium mb-1">Görev Başlığı</label>
                <input type="text" id="task-title" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-doge-yellow focus:border-doge-yellow">
            </div>
            <div>
                <label for="task-description" class="block text-sm font-medium mb-1">Görev Açıklaması / Talimatlar</label>
                <textarea id="task-description" rows="3" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-doge-yellow focus:border-doge-yellow"></textarea>
            </div>
            <div>
                <label for="required-participants" class="block text-sm font-medium mb-1">Hedeflenen Katılımcı Sayısı</label>
                <input type="number" id="required-participants" min="1" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-doge-yellow focus:border-doge-yellow" value="100">
            </div>
            <button type="submit" class="doge-btn w-full py-3 rounded-xl text-lg">
                Görevi Yayınla
            </button>
        </form>
    </div>

    <!-- 5. Para Çekme Sayfası -->
    <div id="withdrawal-page" class="page-content">
        <h2 class="text-2xl font-bold mb-4">Para Çekme Talebi</h2>
        <div id="current-balance-info" class="p-3 bg-light-yellow rounded-lg mb-4 border border-yellow-300">
            Mevcut Bakiye: <span id="current-withdrawal-balance" class="font-bold text-doge-yellow">0.00 Ɖ</span>
        </div>

        <form id="withdrawal-form" class="space-y-4">
            <div>
                <label for="doge-address" class="block text-sm font-medium mb-1">Doge Cüzdan Adresi</label>
                <input type="text" id="doge-address" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-doge-yellow focus:border-doge-yellow">
            </div>
            <div>
                <label for="withdrawal-amount" class="block text-sm font-medium mb-1">Çekilecek Miktar (Ɖ)</label>
                <input type="number" id="withdrawal-amount" min="10" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-doge-yellow focus:border-doge-yellow">
                <p class="text-xs text-gray-500 mt-1">Minimum çekim miktarı 10 Ɖ'dir.</p>
            </div>
            <button type="submit" class="doge-btn w-full py-3 rounded-xl text-lg">
                Talebi Gönder
            </button>
        </form>
    </div>
    
    <!-- 6. Admin Paneli (Sadece Adminler İçin) -->
    <div id="admin-panel" class="page-content">
        <h2 class="text-2xl font-bold mb-4">Admin Paneli <i class="fas fa-user-shield text-red-600"></i></h2>
        <p class="text-sm text-red-600 mb-4">Dikkat: Bu alan sadece yetkili kullanıcılar içindir.</p>
        
        <div class="space-y-4">
            <div class="bg-gray-100 p-4 rounded-xl shadow-inner">
                <h3 class="font-bold text-lg mb-2">Airdrop Yönetimi</h3>
                <p>Airdrop'u manuel olarak çalıştırmak veya ayarları değiştirmek için kullanılır.</p>
                <button id="run-airdrop-manual-btn" class="doge-btn bg-red-500 hover:bg-red-600 py-2 px-4 rounded-lg mt-2 text-sm">
                    Airdrop'u Hemen Çalıştır
                </button>
            </div>
            
            <div class="bg-gray-100 p-4 rounded-xl shadow-inner">
                <h3 class="font-bold text-lg mb-2">Çekim Talepleri</h3>
                <div id="withdrawal-requests-list" class="space-y-2 text-sm">
                    <p class="text-gray-500">Bekleyen çekim talebi bulunmamaktadır.</p>
                    <!-- Çekim talepleri buraya gelecek -->
                </div>
            </div>
        </div>
    </div>


</div> <!-- end of main-container -->

<!-- Firebase SDK'ları -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, query, getDocs, addDoc, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getDatabase, ref as rtdbRef, onValue, set } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

    // --- KULLANICININ SAĞLADIĞI FIREBASE YAPILANDIRMASI ---
    const USER_PROVIDED_FIREBASE_CONFIG = {
        apiKey: "AIzaSyDFsCndvDJPFFdOHwRltMawNoTDR_kXJ7E",
        authDomain: "dogeoradvertise.firebaseapp.com",
        databaseURL: "https://dogeoradvertise-default-rtdb.firebaseio.com",
        projectId: "dogeoradvertise",
        storageBucket: "dogeoradvertise.firebasestorage.app",
        messagingSenderId: "175042727969",
        appId: "1:175042727969:web:32e18b90d987ea61ba9360",
        measurementId: "G-6DW9PYENYN"
    };

    // Zorunlu Canvas Global Değişkenlerini Yükleme (firebaseConfig artık kullanıcıdan geldiği için sadece token ve app id kullanılıyor)
    const firebaseConfig = USER_PROVIDED_FIREBASE_CONFIG;
    
    // Uygulama ID'sini Canvas ortamından al, yoksa kullanıcı konfigürasyonundan al
    const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId; 
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // Admin kullanıcı kimliği için yer tutucu. Gerçek uygulamada güvenli bir şekilde yönetilmelidir.
    const ADMIN_USER_ID = 'ADMIN_DOGE_USER'; 

    let app, auth, db, rtdb;
    let userId = null;
    let isAuthReady = false;
    let unsubscribeUser = null;
    let unsubscribeAirdrop = null;

    // Ödül ve Ayarlar
    const AD_REWARD = 0.01;
    const TASK_REWARD = 0.02;
    const AIRDROP_INTERVAL_MS = 60 * 60 * 1000; // 1 Saat
    const AIRDROP_WINNER_PERCENTAGE = 0.25;
    // GÜNCELLENDİ: Kazanan başına sabit ödül 0.25 Ɖ olarak ayarlandı
    const AIRDROP_REWARD_PER_WINNER = 0.25; 

    // Firestore Yol Yardımcı Fonksiyonları
    const getUserDocRef = (uid) => doc(db, 'artifacts', appId, 'users', uid, 'userData', 'profile');
    const getTasksCollection = () => collection(db, 'artifacts', appId, 'public', 'data', 'tasks');
    const getAirdropStateDocRef = () => doc(db, 'artifacts', appId, 'public', 'data', 'airdrop_state', 'latest');
    const getWithdrawalCollection = () => collection(db, 'artifacts', appId, 'public', 'data', 'withdrawals');

    // --- UTILITY FUNCTIONS ---

    // Mesaj Kutusu Gösterme (alert yerine)
    function showMessage(message, type = 'success') {
        const msgBox = document.getElementById('message-box');
        msgBox.textContent = message;
        msgBox.className = 'fixed top-16 left-1/2 transform -translate-x-1/2 p-3 rounded-lg shadow-xl z-50 transition-opacity duration-300';
        
        if (type === 'success') {
            msgBox.classList.add('bg-green-500', 'text-white');
            msgBox.classList.remove('bg-red-500', 'bg-blue-500');
        } else if (type === 'error') {
            msgBox.classList.add('bg-red-500', 'text-white');
            msgBox.classList.remove('bg-green-500', 'bg-blue-500');
        } else {
            msgBox.classList.add('bg-blue-500', 'text-white');
            msgBox.classList.remove('bg-green-500', 'bg-red-500');
        }

        msgBox.classList.remove('opacity-0', 'pointer-events-none');
        setTimeout(() => {
            msgBox.classList.add('opacity-0', 'pointer-events-none');
        }, 3000);
    }

    // Rastgele Sayı Seçme
    function getRandomWinners(participants) {
        const numWinners = Math.ceil(participants.length * AIRDROP_WINNER_PERCENTAGE);
        const winners = [];
        const pool = [...participants];

        for (let i = 0; i < numWinners; i++) {
            if (pool.length === 0) break;
            const randomIndex = Math.floor(Math.random() * pool.length);
            winners.push(pool.splice(randomIndex, 1)[0]);
        }
        return winners;
    }

    // --- APLICATION LOGIC ---

    // Airdrop İşlemini Çalıştırma
    async function runAirdrop() {
        if (!userId) return;
        if (userId !== ADMIN_USER_ID) return; // Sadece admin çalıştırabilir.

        try {
            const airdropRef = getAirdropStateDocRef();
            const airdropDoc = await getDoc(airdropRef);
            
            if (!airdropDoc.exists()) return;
            
            const state = airdropDoc.data();
            const participants = state.participants || [];
            
            if (participants.length === 0) {
                console.log("Airdrop: Katılımcı yok.");
                await setDoc(airdropRef, { lastRunTime: Date.now(), participants: [] }, { merge: true });
                return;
            }

            // 1. Kazananları Seç
            const winners = getRandomWinners(participants);
            // GÜNCELLENDİ: Kazanan başına sabit ödül kullanılıyor
            const prizePerWinner = AIRDROP_REWARD_PER_WINNER; 
            
            // 2. Ödülleri Dağıt
            // Firestore updateDoc'ta field value increment olmadığı için manuel güncelleme yapıyoruz.
            const updates = winners.map(async winnerId => {
                const userRef = getUserDocRef(winnerId);
                const userSnapshot = await getDoc(userRef);
                const currentBalance = userSnapshot.data()?.balance || 0;
                
                await updateDoc(userRef, {
                    balance: currentBalance + prizePerWinner,
                    totalEarned: (userSnapshot.data()?.totalEarned || 0) + prizePerWinner
                }).catch(e => console.error(`Airdrop ödül dağıtımı başarısız: ${winnerId}`, e));
            });

            await Promise.all(updates);

            showMessage(`${winners.length} kişi Airdrop kazandı! Her biri ${prizePerWinner.toFixed(4)} Ɖ aldı.`, 'success');

            // 3. Airdrop Durumunu Sıfırla
            await setDoc(airdropRef, { 
                lastRunTime: Date.now(), 
                participants: [],
                lastWinners: winners.length,
                lastPrize: prizePerWinner
            }, { merge: true });

        } catch (error) {
            console.error("Airdrop çalıştırma hatası:", error);
            showMessage("Airdrop çalıştırılırken bir hata oluştu.", 'error');
        }
    }

    // Airdrop Durumunu Dinleme
    function setupAirdropListener() {
        if (unsubscribeAirdrop) unsubscribeAirdrop();
        
        const airdropRef = getAirdropStateDocRef();
        
        unsubscribeAirdrop = onSnapshot(airdropRef, async (docSnapshot) => {
            const btn = document.getElementById('join-airdrop-btn');
            const timerEl = document.getElementById('airdrop-timer');
            const participantsEl = document.getElementById('airdrop-participants');

            if (!docSnapshot.exists()) {
                // İlk kurulum
                await setDoc(airdropRef, { lastRunTime: Date.now() - AIRDROP_INTERVAL_MS, participants: [] });
                return;
            }

            const state = docSnapshot.data();
            const lastRunTime = state.lastRunTime || 0;
            const participants = state.participants || [];
            
            participantsEl.textContent = `Katılımcı Sayısı: ${participants.length}`;

            // Kullanıcı zaten katılmış mı?
            const isJoined = participants.includes(userId);
            
            if (isJoined) {
                btn.textContent = "Katıldınız!";
                btn.disabled = true;
                btn.classList.add('opacity-70');
            } else {
                btn.textContent = "Airdrop'a Katıl";
                btn.disabled = false;
                btn.classList.remove('opacity-70');
            }


            // Zamanlayıcı ve Otomatik Çalıştırma Kontrolü
            const updateTimer = () => {
                const elapsed = Date.now() - lastRunTime;
                const remaining = AIRDROP_INTERVAL_MS - elapsed;

                if (remaining <= 0) {
                    timerEl.textContent = "ÖDÜL DAĞITILIYOR...";
                    // 1 saat geçtiyse otomatik çalıştır (Sadece Admin çalıştırır)
                    if (userId === ADMIN_USER_ID && !window.airdropRunning) {
                         window.airdropRunning = true;
                         runAirdrop().finally(() => { window.airdropRunning = false; });
                    }
                    // Tekrar çalıştırmadan önce intervali temizle
                    clearInterval(window.airdropTimerInterval); 
                    // Yeni bir airdrop başladığı için dinleyicinin tekrar tetiklenmesini bekleriz.
                } else {
                    const totalSeconds = Math.floor(remaining / 1000);
                    const hours = Math.floor(totalSeconds / 3600);
                    const minutes = Math.floor((totalSeconds % 3600) / 60);
                    const seconds = totalSeconds % 60;
                    
                    timerEl.textContent = `Sıradaki Çekiliş: ${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                    
                    if (isJoined) {
                         btn.textContent = "Zaten Katıldınız";
                         btn.disabled = true;
                    }
                }
            };

            if (window.airdropTimerInterval) clearInterval(window.airdropTimerInterval);
            window.airdropTimerInterval = setInterval(updateTimer, 1000);
            updateTimer(); // İlk çalıştırma
        }, (error) => {
            console.error("Airdrop dinleyicisi hatası:", error);
        });
    }

    // Airdrop'a Katılma
    document.getElementById('join-airdrop-btn').addEventListener('click', async () => {
        if (!userId) return showMessage("Lütfen bekleyin, kullanıcı verileri yükleniyor.", 'error');

        const btn = document.getElementById('join-airdrop-btn');
        btn.disabled = true;

        try {
            const airdropRef = getAirdropStateDocRef();
            const airdropDoc = await getDoc(airdropRef);
            
            if (!airdropDoc.exists()) {
                 await setDoc(airdropRef, { lastRunTime: Date.now() - AIRDROP_INTERVAL_MS, participants: [] });
            }
            
            const state = airdropDoc.data();
            const participants = state.participants || [];

            if (participants.includes(userId)) {
                showMessage("Zaten katıldınız!", 'error');
                return;
            }

            // Katılımcı listesine ekle
            await updateDoc(airdropRef, {
                participants: [...participants, userId]
            });

            showMessage("Airdrop'a başarıyla katıldınız!", 'success');

        } catch (e) {
            console.error("Airdrop'a katılma hatası:", e);
            showMessage("Katılım başarısız oldu. Tekrar deneyin.", 'error');
        } finally {
            // Dinleyici otomatik olarak güncelleyecektir.
        }
    });

    // --- Earning Mechanics ---

    // Reklam İzleme Simülasyonu
    document.getElementById('view-ad-btn').addEventListener('click', async () => {
        if (!userId) return showMessage("Oturum açılamadı. Tekrar deneyin.", 'error');
        
        const btn = document.getElementById('view-ad-btn');
        btn.disabled = true;
        btn.textContent = "İzleniyor...";
        
        try {
            // Reklam izleme süresi simülasyonu
            await new Promise(resolve => setTimeout(resolve, 3000)); 
            
            const userRef = getUserDocRef(userId);
            const userDoc = await getDoc(userRef);
            const userData = userDoc.data() || { balance: 0, totalEarned: 0, totalAdsViewed: 0 };
            
            // Güncelleme
            await updateDoc(userRef, {
                balance: userData.balance + AD_REWARD,
                totalAdsViewed: userData.totalAdsViewed + 1,
                totalEarned: userData.totalEarned + AD_REWARD,
            });
            
            showMessage(`0.01 Ɖ bakiyenize eklendi!`, 'success');
        } catch (e) {
            console.error("Reklam izleme hatası:", e);
            showMessage("Reklam izlenirken bir hata oluştu.", 'error');
        } finally {
            btn.disabled = false;
            btn.textContent = "Reklamı İzle (0.01 Ɖ Kazan)";
        }
    });

    // Örnek Görevi Tamamlama (Task Completion)
    document.getElementById('current-tasks-list').addEventListener('click', async (e) => {
        if (!e.target.classList.contains('complete-task-btn')) return;
        if (!userId) return showMessage("Oturum açılamadı. Tekrar deneyin.", 'error');

        const taskId = e.target.dataset.taskId;
        const btn = e.target;
        btn.disabled = true;
        btn.textContent = "Tamamlanıyor...";
        
        try {
            // Görev tamamlandıktan sonra bekleme simülasyonu
            await new Promise(resolve => setTimeout(resolve, 2000)); 
            
            const userRef = getUserDocRef(userId);
            const userDoc = await getDoc(userRef);
            const userData = userDoc.data() || { balance: 0, totalEarned: 0, totalTasksCompleted: 0 };
            
            // Güncelleme
            await updateDoc(userRef, {
                balance: userData.balance + TASK_REWARD,
                totalTasksCompleted: userData.totalTasksCompleted + 1,
                totalEarned: userData.totalEarned + TASK_REWARD,
            });
            
            showMessage(`0.02 Ɖ görevden kazanıldı!`, 'success');

        } catch (e) {
            console.error("Görev tamamlama hatası:", e);
            showMessage("Görev tamamlama başarısız oldu.", 'error');
        } finally {
            btn.disabled = true; // Görev bir kez yapılabilir.
            btn.textContent = "Tamamlandı";
        }
    });


    // Görev Oluşturma
    document.getElementById('create-task-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!userId) return showMessage("Oturum açılamadı. Tekrar deneyin.", 'error');

        const title = document.getElementById('task-title').value;
        const description = document.getElementById('task-description').value;
        const required = parseInt(document.getElementById('required-participants').value, 10);
        const cost = required * TASK_REWARD;
        
        if (cost <= 0 || required < 1) return showMessage("Geçerli bir katılımcı sayısı girin.", 'error');

        try {
            const userDoc = await getDoc(getUserDocRef(userId));
            const userBalance = userDoc.data()?.balance || 0;

            // Gerçek uygulamada, bakiye kontrolü ve çekme işlemi burada yapılmalıdır.
            // if (userBalance < cost) { return showMessage("Bakiyeniz yeterli değil.", 'error'); }

            // Yeni Görev Oluşturma
            const newTask = {
                title,
                description,
                creatorId: userId,
                rewardPerUser: TASK_REWARD,
                requiredCompletions: required,
                currentCompletions: 0,
                totalCost: cost,
                isActive: true,
                createdAt: serverTimestamp()
            };

            await addDoc(getTasksCollection(), newTask);
            
            showMessage(`Görev başarıyla yayınlandı! Toplam maliyet: ${cost.toFixed(4)} Ɖ.`, 'success');
            document.getElementById('create-task-form').reset();
            showSection('tasks-page');

        } catch (error) {
            console.error("Görev oluşturma hatası:", error);
            showMessage("Görev oluşturulurken bir hata oluştu.", 'error');
        }
    });

    // Para Çekme Talebi
    document.getElementById('withdrawal-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!userId) return showMessage("Oturum açılamadı. Tekrar deneyin.", 'error');

        const address = document.getElementById('doge-address').value;
        const amount = parseFloat(document.getElementById('withdrawal-amount').value);
        const minWithdrawal = 10;
        
        if (amount < minWithdrawal) return showMessage(`Minimum çekim miktarı ${minWithdrawal} Ɖ'dir.`, 'error');

        try {
            const userRef = getUserDocRef(userId);
            const userDoc = await getDoc(userRef);
            const userBalance = userDoc.data()?.balance || 0;

            if (userBalance < amount) {
                return showMessage("Yetersiz bakiye!", 'error');
            }

            // Çekim Talebi Oluşturma
            await addDoc(getWithdrawalCollection(), {
                userId,
                dogeAddress: address,
                amount,
                status: 'Beklemede',
                timestamp: serverTimestamp()
            });

            // Bakiyeden Düşme
            await updateDoc(userRef, {
                balance: userBalance - amount,
            });

            showMessage("Çekim talebiniz başarıyla oluşturuldu ve inceleniyor.", 'success');
            document.getElementById('withdrawal-form').reset();
            
        } catch (error) {
            console.error("Çekim talebi hatası:", error);
            showMessage("Çekim talebi oluşturulurken bir hata oluştu.", 'error');
        }
    });

    // --- UI/STATE Management ---

    // Kullanıcı Verilerini Dinleme
    function setupUserListener() {
        if (unsubscribeUser) unsubscribeUser();
        
        const userRef = getUserDocRef(userId);
        
        unsubscribeUser = onSnapshot(userRef, (docSnapshot) => {
            const data = docSnapshot.data();
            const balance = data?.balance || 0.00;
            const totalEarned = data?.totalEarned || 0.00;
            const totalAds = data?.totalAdsViewed || 0;
            const totalTasks = data?.totalTasksCompleted || 0;
            
            // Ana Sayfa Güncelleme
            document.getElementById('doge-balance').textContent = `${balance.toFixed(4)} Ɖ`;
            document.getElementById('total-earned').textContent = `${totalEarned.toFixed(4)} Ɖ`;
            document.getElementById('total-ads').textContent = totalAds;
            document.getElementById('total-tasks').textContent = totalTasks;

            // Çekim Sayfası Güncelleme
            document.getElementById('current-withdrawal-balance').textContent = `${balance.toFixed(4)} Ɖ`;

        }, (error) => {
            console.error("Kullanıcı veri dinleyicisi hatası:", error);
        });
    }

    // Admin Paneli Dinleyicisi (Örnek)
    function setupAdminListener() {
        if (userId !== ADMIN_USER_ID) return;

        onSnapshot(query(getWithdrawalCollection(), where('status', '==', 'Beklemede')), (snapshot) => {
            const listEl = document.getElementById('withdrawal-requests-list');
            listEl.innerHTML = '';
            
            if (snapshot.empty) {
                listEl.innerHTML = '<p class="text-gray-500">Bekleyen çekim talebi bulunmamaktadır.</p>';
                return;
            }

            snapshot.forEach(doc => {
                const req = doc.data();
                const reqId = doc.id;
                const reqEl = document.createElement('div');
                reqEl.className = 'border-b pb-2';
                reqEl.innerHTML = `
                    <p class="font-medium">${req.amount.toFixed(4)} Ɖ (Kullanıcı: ${req.userId.substring(0, 8)}...)</p>
                    <p class="text-xs truncate">Cüzdan: ${req.dogeAddress}</p>
                    <button data-id="${reqId}" class="process-withdrawal doge-btn bg-green-500 hover:bg-green-600 py-1 px-2 rounded-md mt-1 text-xs">Öde</button>
                `;
                listEl.appendChild(reqEl);
            });
        });
        
        document.getElementById('run-airdrop-manual-btn').addEventListener('click', runAirdrop);
    }

    // Sayfa Gösterme Fonksiyonu
    function showSection(pageId) {
        document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
        const targetPage = document.getElementById(pageId);
        if (targetPage) {
            targetPage.classList.add('active');
        }
        closeDrawer();
    }
    window.showSection = showSection; // Genel erişim için

    // Yan Menü İşlemleri
    const drawer = document.getElementById('drawer');
    const overlay = document.getElementById('drawer-overlay');
    const menuToggle = document.getElementById('menu-toggle');
    
    function toggleDrawer() {
        drawer.classList.toggle('open');
        overlay.classList.toggle('open');
    }
    function closeDrawer() {
        drawer.classList.remove('open');
        overlay.classList.remove('open');
    }
    
    menuToggle.addEventListener('click', toggleDrawer);
    overlay.addEventListener('click', closeDrawer);
    
    // Menü öğelerine tıklama
    document.querySelectorAll('#drawer .menu-item').forEach(item => {
        item.addEventListener('click', (e) => {
            const page = e.currentTarget.dataset.page;
            showSection(page);
        });
    });

    // --- INITIALIZATION ---

    async function initFirebase() {
        try {
            document.getElementById('loading-indicator').style.display = 'block';

            // 1. Firebase Başlatma (Kullanıcının sağladığı yapılandırma ile)
            app = initializeApp(firebaseConfig); 
            auth = getAuth(app);
            db = getFirestore(app);
            rtdb = getDatabase(app); 
            
            // 2. Oturum Açma
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }

        } catch (error) {
            console.error("Firebase başlatma/oturum açma hatası:", error);
            
            if (error.code === 'auth/invalid-api-key') {
                showMessage("Kritik Hata: API Anahtarı hala geçersiz görünüyor. Lütfen konsolu kontrol edin.", 'error');
            } else {
                showMessage(`Uygulama yüklenirken kritik bir hata oluştu: ${error.code || 'Bilinmeyen Hata'}`, 'error');
            }
        }
    }

    // Uygulama Başlangıcı
    document.addEventListener('DOMContentLoaded', async () => {
        await initFirebase();

        onAuthStateChanged(auth, (user) => {
            document.getElementById('loading-indicator').style.display = 'none';

            if (user) {
                userId = user.uid;
                isAuthReady = true;

                // Kullanıcı ID'sini göster
                document.getElementById('drawer-user-id').textContent = `ID: ${userId}`;
                
                // Admin Kontrolü
                if (userId === ADMIN_USER_ID) {
                    document.getElementById('admin-menu-item').classList.remove('hidden');
                    setupAdminListener();
                } else {
                    document.getElementById('admin-menu-item').classList.add('hidden');
                }

                // Kullanıcıya ilk kez giriyorsa varsayılan bakiye ve istatistik ata
                const userRef = getUserDocRef(userId);
                setDoc(userRef, { 
                    balance: 0.00, 
                    totalEarned: 0.00,
                    totalAdsViewed: 0,
                    totalTasksCompleted: 0
                }, { merge: true }).catch(e => console.error("İlk kullanıcı verisi oluşturma hatası", e));

                setupUserListener();
                setupAirdropListener();
                showSection('menu-page');

            } else {
                console.log("Oturum kapatıldı veya anonim oturum açılamadı.");
                showMessage("Oturum açılamadı, lütfen tekrar deneyin.", 'error');
            }
        });
    });
</script>

</body>
</html>

