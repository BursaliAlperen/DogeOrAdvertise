<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Doge Or Advertise</title> <script src="https://telegram.org/js/telegram-web-app.js?56"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    
    <style>
        /* SARI/BEYAZ TEMA VE DOGE GÃœNCELLEMELERÄ° */
        :root {
            --font-family: 'Nunito', sans-serif;
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --text-color: #1c1c1e;
            --subtle-text: #888;
            --primary-color: #FFD700; /* AltÄ±n SarÄ± */
            --primary-color-hover: #FFC107; /* Daha Koyu SarÄ± */
            --border-color: #e0e0e0;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --radius: 12px;
            /* SarÄ± temaya uygun renkler */
            --yellow-light-bg: #FFFBEA;
            --yellow-border: #FFD700; 
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        #app { max-width: 500px; margin: 0 auto; padding-bottom: 80px; }

        .header { padding: 20px; display: flex; align-items: center; justify-content: space-between; background-color: var(--primary-color); color: var(--text-color); border-radius: 0 0 var(--radius) var(--radius); box-shadow: var(--shadow); }
        .header h1 { font-size: 1.4rem; font-weight: 800; }
        .header-stats { text-align: right; font-size: 0.9rem; }
        .header-stats p strong { display: block; font-size: 1.1rem; }

        main { padding: 15px; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* BAÅžLIK SÄ°MGESÄ° GÃœNCELLENDÄ° */
        h2 { font-size: 1.6rem; margin-bottom: 20px; color: var(--primary-color); border-left: 4px solid var(--primary-color); padding-left: 10px; }
        
        .card { padding: 20px; border-radius: var(--radius); background-color: var(--card-bg); box-shadow: var(--shadow); margin-bottom: 20px; transition: transform 0.2s; }
        .card:hover { transform: translateY(-2px); }
        
        .action-btn { width: 100%; padding: 15px; font-size: 1.1rem; font-weight: 700; color: #fff; border: none; border-radius: 10px; cursor: pointer; transition: background-color 0.2s, transform 0.1s; display: flex; justify-content: center; align-items: center; background-color: var(--primary-color); color: var(--text-color); }
        .action-btn:active { transform: scale(0.98); }
        .action-btn:hover { background-color: var(--primary-color-hover); }
        .action-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .action-btn.loading { background-color: #FF9800; cursor: wait; pointer-events: none; } 

        .balance-card { text-align: center; border: 2px solid var(--primary-color); background-color: var(--yellow-light-bg); }
        .balance-card .usd-value { font-size: 2.5rem; font-weight: 800; color: var(--primary-color); line-height: 1.2; }
        .balance-card .doge-value { font-size: 1.2rem; color: var(--subtle-text); margin-top: 5px; }
        
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 15px; }
        .menu-tile { padding: 15px; border-radius: var(--radius); text-align: center; background-color: var(--card-bg); box-shadow: var(--shadow); cursor: pointer; transition: background-color 0.2s, transform 0.1s; }
        .menu-tile i { font-size: 2rem; color: var(--primary-color); margin-bottom: 10px; }
        .menu-tile span { font-size: 0.9rem; font-weight: 600; display: block; }
        .menu-tile:hover { background-color: var(--yellow-light-bg); }

        .input-group button { background-color: var(--primary-color); color: var(--text-color); }
        .input-group button:hover { background-color: var(--primary-color-hover); }

        /* Admin paneli buton renkleri sarÄ±ya uygun gÃ¼ncellendi */
        #admin-panel li { border: 1px solid var(--yellow-border); border-radius: 8px; padding: 15px; margin-bottom: 10px; background-color: var(--yellow-light-bg); }
        #admin-panel li strong { color: var(--primary-color); }
        #admin-panel .approve-btn { background-color: #4CAF50; color: white; border: none; }
        #admin-panel .reject-btn { background-color: #f44336; color: white; border: none; }
        #admin-panel .orange-btn { background-color: #ff9800; color: white; border: none; }
        #admin-panel .info-btn { background-color: #2196F3; color: white; border: none; }

        .nav-btn.active { font-weight: 700; color: var(--primary-color); }
        
        /* Yeni: Reklam ve GÃ¶rev KartÄ± Stilini Ayarlama */
        .task-card { text-align: center; border-left: 5px solid; margin-bottom: 20px;}
        .task-card.watch-ad { border-left-color: #4CAF50; }
        .task-card.sponsored { border-left-color: var(--primary-color); }

        /* ARAYÃœZ HATA DÃœZELTMELERÄ° Ä°Ã‡Ä°N EKLENEN/GÃœNCELLENEN STÄ°LLER */
        
        /* General Input and Form Styles for better UI */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 0.9rem; font-weight: 600; margin-bottom: 5px; color: var(--text-color); }
        .form-group input, .input-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            color: var(--text-color);
            background-color: var(--bg-color);
            transition: border-color 0.2s;
        }
        .form-group input:focus, .input-group input:focus {
            border-color: var(--primary-color);
            outline: none;
            background-color: var(--card-bg);
        }

        .input-group {
            display: flex;
            gap: 10px;
        }
        .input-group input { flex-grow: 1; }
        .input-group button {
            padding: 10px 15px;
            white-space: nowrap;
            border-radius: 8px;
            font-weight: 700;
        }
        
        /* Admin Panel & Stats Display */
        .stat-display { 
            display: flex; 
            justify-content: space-between; 
            padding: 8px 0; 
            border-bottom: 1px dashed var(--border-color); 
            font-size: 0.95rem; 
        }
        .stat-display:last-child { border-bottom: none; }
        .stat-display strong { color: var(--primary-color); }

        .user-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 5px;
            margin-top: 5px;
            padding-top: 5px;
            border-top: 1px dotted #ccc;
        }
        .stat-item {
            font-size: 0.85rem;
            line-height: 1.2;
        }
        .stat-item div:first-child { color: var(--subtle-text); }
        .stat-item .stat-value { font-weight: 700; color: var(--text-color); }

        .scrollable-list {
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: #f9f9f9;
        }

        /* BOTTOM NAVIGATION BAR STYLES (ArayÃ¼z hatasÄ±nÄ± Ã§Ã¶zen ana kÄ±sÄ±m) */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            max-width: 500px;
            margin: 0 auto;
            display: flex;
            justify-content: space-around;
            background-color: var(--card-bg);
            border-top: 1px solid var(--border-color);
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.05);
            z-index: 1000;
            padding: 5px 0;
        }
        .nav-btn {
            background: none;
            border: none;
            color: var(--subtle-text);
            cursor: pointer;
            padding: 8px 0;
            flex-grow: 1;
            text-align: center;
            font-size: 0.75rem;
            transition: color 0.2s;
            display: block; 
        }
        .nav-btn i {
            display: block;
            font-size: 1.2rem;
            margin-bottom: 3px;
        }
        .nav-btn.active {
            color: var(--primary-color);
        }
    </style>
</head>
<body>

    <div id="app">
        <header class="header">
            <div>
                <h1>Doge Or Advertise</h1> <p style="font-size:0.9rem;">The simplest way to earn DOGE.</p>
            </div>
            <div class="header-stats">
                <p>Current Price (DOGE)</p>
                <p><strong>$<span id="current-doge-price">0.0000</span></strong></p>
                <div id="admin-indicator" style="display:none; font-weight:bold; color:#2196F3; margin-top:5px;">ADMIN MODE</div>
            </div>
        </header>

        <main id="main-content">
            
            <div id="banned-screen" class="page" style="text-align: center; padding: 40px; background-color: #ffebeb; border: 3px solid #D32F2F; margin-top: 20px;">
                <i class="fas fa-exclamation-triangle" style="font-size: 4rem; color: #D32F2F; margin-bottom: 15px;"></i>
                <h2>ACCOUNT SUSPENDED</h2>
                <p style="font-size: 1.1rem; color: #1c1c1e; margin-bottom: 20px;">Your access to the DOGE Ads Faucet has been temporarily or permanently suspended.</p>
                
                <div class="card" style="background-color: #fff; border: 1px solid #f0f0f0;">
                    <h3 style="color: #D32F2F; margin-bottom: 10px;">Reason for Suspension:</h3>
                    <p id="ban-reason-display" style="font-weight: 700; font-size: 1rem; color: #333;">Loading reason...</p>
                </div>

                <p style="margin-top: 25px; font-size: 0.9rem; color: #888;">If you believe this is an error, please contact support with your Telegram ID.</p>
            </div>
            
            <div id="admin-panel" class="page">
                <h2><i class="fas fa-user-shield"></i> Admin Panel</h2>
                
                <div class="card">
                    <h3>System Stats (RTDB)</h3>
                    <div class="stat-display"><span>Total Users:</span> <strong id="admin-user-count">0</strong></div>
                    <div class="stat-display"><span>Total User Balance (USD):</span> <strong id="admin-total-balance">$0.00</strong></div>
                    <div class="stat-display"><span>Total Sponsored Tasks Done:</span> <strong id="admin-total-tasks">0</strong></div>
                    <div class="stat-display"><span>Total Referrals:</span> <strong id="admin-total-referrals">0</strong></div>
                    <div class="stat-display"><span>Total Clicks Paid:</span> <strong id="admin-total-clicks">0</strong></div>
                </div>
                
                <div class="card">
                    <h3>User Management</h3>
                    <div class="input-group" style="margin-bottom: 10px;">
                        <input type="text" id="user-search-input" placeholder="Search by Telegram ID or Username">
                        <button onclick="loadAllUsers(true)" style="border-radius: 8px;"><i class="fas fa-search"></i> Search</button>
                    </div>
                    <div class="input-group">
                        <input type="text" id="user-uid-input" placeholder="User UID to ban (e.g., tg_user_12345)">
                        <button onclick="manualBanUser(document.getElementById('user-uid-input').value.trim())"><i class="fas fa-ban"></i> Ban User</button>
                    </div>
                    <div style="margin-top: 10px;">
                        <button onclick="loadAllUsers()" class="action-btn" style="padding: 10px;">
                            <i class="fas fa-sync-alt"></i> Refresh All Users
                        </button>
                    </div>
                </div>

                <div class="card">
                    <h3>All Users List (Scrollable)</h3>
                    <div id="users-list-scrollable-container" class="scrollable-list">
                        <ul id="users-list">
                            <p style="color:var(--subtle-text);">Click refresh to load users...</p>
                        </ul>
                    </div>
                </div>

                <div class="card">
                    <h3>Banned Users (Scrollable)</h3>
                    <div id="banned-users-list-scrollable-container" class="scrollable-list">
                        <ul id="banned-users-list">
                            <p style="color:var(--subtle-text);">Loading banned users...</p>
                        </ul>
                    </div>
                </div>
                
                <h3 style="margin-top:25px;">Pending Withdrawal Requests (Firestore - Scrollable)</h3>
                <div class="card" style="margin-top: 10px;">
                    <div id="withdrawal-list-scrollable-container" class="scrollable-list">
                        <ul id="withdrawal-list">
                            <p style="color:var(--subtle-text);">Loading requests...</p>
                        </ul>
                    </div>
                </div>
            </div>

            <div id="menu-page" class="page">
                <h2><i class="fas fa-list-check"></i> Tasks & Earning</h2>
                <div class="card balance-card">
                    <p style="font-size:1.1rem; color:var(--subtle-text);">Your Current Balance (DOGE)</p>
                    <div class="usd-value"><span id="menu-balance-doge">0.0000</span> DOGE</div>
                    <div class="doge-value">â‰ˆ $<span id="menu-balance-usd">0.00</span></div>
                </div>
                
                <div class="card task-card watch-ad">
                    <i class="fas fa-video" style="font-size:3rem; color: #4CAF50;"></i>
                    <h3>Watch & Earn DOGE</h3>
                    <p style="margin-bottom:15px;">Watch a quick sponsored ad and earn **<span id="ad-reward-doge">0.01</span> DOGE**.</p>
                    <button id="watch-ad-btn" class="action-btn" style="background-color:#4CAF50; color: white;">
                        <i class="fas fa-play-circle" style="margin-right:10px;"></i> Watch Ad
                    </button>
                    <p class="withdraw-note" id="ad-status" style="margin-top:10px;">Status: <strong style="color:red;">Loading...</strong></p>
                </div>
                
                <div class="card task-card sponsored">
                    <i class="fas fa-bullhorn" style="font-size:3rem; color: var(--primary-color);"></i>
                    <h3>Sponsored Task: Join Airdrop</h3>
                    <p style="margin-bottom:15px;">Complete this one-time task to earn **<span id="task-reward-doge">0.02</span> DOGE**.</p>
                    <button id="sponsored-task-btn" class="action-btn">
                        <i class="fas fa-arrow-alt-circle-right" style="margin-right:10px;"></i> Go to Sponsored Task
                    </button>
                    <p class="withdraw-note" id="task-status" style="margin-top:10px;">Status: <strong style="color:red;">Not Completed</strong></p>
                </div>
                
                <div class="menu-grid" style="margin-top: 15px;">
                    <div onclick="showSection('friends-page')" class="menu-tile">
                        <i class="fas fa-users"></i>
                        <span>Friends & Referrals</span>
                    </div>
                    <div onclick="showSection('withdraw-page')" class="menu-tile">
                        <i class="fas fa-wallet"></i>
                        <span>Withdraw DOGE</span>
                    </div>
                     <div onclick="showSection('ad-management-page')" class="menu-tile">
                        <i class="fas fa-money-bill-wave"></i>
                        <span>Ad Management</span>
                    </div>
                </div>
            </div>

            <div id="friends-page" class="page">
                <h2><i class="fas fa-user-friends"></i> Referral System</h2>
                
                <div class="card" style="text-align:center; border: 2px solid #5cb85c; background-color: #e6ffe6;">
                    <p style="font-size:1rem; color:#3c763d;">Total Referred Friends:</p>
                    <div style="font-size:2.5rem; font-weight:800; color:#4CAF50; line-height:1.2;" id="referral-count-display">0</div>
                </div>
                
                <div class="card">
                    <p style="font-weight:700; color:var(--primary-color);">Referral Bonus: Get **~0.03 DOGE** for every successful friend! (Equivalent to $0.005 USD)</p>
                    
                    <h3 style="font-size:1.2rem; margin-top:15px; margin-bottom:5px;">Your Referral Link (Share this!)</h3>
                    <div class="input-group">
                        <input type="text" id="referral-code-input" value="" placeholder="Loading..." readonly>
                        <button onclick="copyToClipboard('referral-code-input')"><i class="fas fa-copy"></i> Copy Link</button>
                    </div>
                    
                    <button id="share-ref-btn" class="action-btn" style="margin-top:0;"><i class="fas fa-share-alt" style="margin-right:10px;"></i> Share Promotional Text</button>

                    <h3 style="font-size:1.2rem; margin-top:25px; margin-bottom:5px;">Enter Friend's Code</h3>
                    <p class="withdraw-note">You can only use one code once.</p>
                    <div class="input-group">
                        <input type="text" id="enter-referrer-code" placeholder="Enter friend's Telegram ID">
                        <button onclick="applyReferralCode()"><i class="fas fa-arrow-right"></i> Apply</button>
                    </div>
                </div>
                
                </div>
            
            <div id="withdraw-page" class="page">
                <h2><i class="fas fa-money-check-alt"></i> Withdraw DOGE</h2>
                <div class="card balance-card" style="margin-bottom: 20px;">
                    <p style="font-size:0.9rem; color:var(--subtle-text);">Available DOGE:</p>
                    <div class="usd-value" style="font-size:2rem;"><span id="withdraw-balance-doge">0.0000</span> DOGE</div>
                </div>
                
                <p style="font-weight:700;">Minimum withdrawal: **<span id="min-withdraw-display">5.00</span> DOGE**.<br>Maximum withdrawal: **<span id="max-withdraw-display">50.00</span> DOGE**.</p>
                <form id="withdraw-form" style="margin-top:15px;">
                    <div class="form-group">
                        <label for="doge-address"><i class="fas fa-truck-moving"></i> DOGE Wallet Address:</label>
                        <input type="text" id="doge-address" placeholder="Dxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" required>
                    </div>
                    <div class="form-group">
                        <label for="amount-doge"><i class="fas fa-coins"></i> Amount (DOGE):</label>
                        <input type="number" id="amount-doge" step="0.01" placeholder="e.g., 5.00" required>
                    </div>
                    <p class="withdraw-note">This equals: <strong id="withdraw-usd-amount">$0.00</strong> USD</p>
                    <button type="submit" id="withdraw-submit-btn" class="action-btn" style="margin-top:15px;">
                        <i class="fas fa-paper-plane" style="margin-right:10px;"></i> Submit Withdrawal Request
                    </button>
                </form>
            </div>
            
            <div id="ad-management-page" class="page">
                <h2><i class="fas fa-money-bill-wave"></i> Ad Management</h2>
                
                <div class="card">
                    <h3>Create New Campaign</h3>
                    <p class="withdraw-note" style="margin-bottom: 10px;">Promote your Telegram Channel or Bot! Each click costs **<span id="cpc-doge">0.01</span> DOGE** and is automatically verified by our bot system.</p>
                    <div class="form-group">
                        <label for="ad-link">Telegram Link (Channel/Bot URL):</label>
                        <input type="url" id="ad-link" placeholder="e.g., https://t.me/YourChannel" required> 
                    </div>
                    <div class="form-group">
                        <label for="ad-budget-doge">Total Budget (DOGE):</label>
                        <input type="number" id="ad-budget-doge" step="1" placeholder="Minimum 10 DOGE" required> 
                    </div>
                    <button id="create-ad-btn" class="action-btn">
                        <i class="fas fa-plus-circle" style="margin-right:10px;"></i> Create Campaign
                    </button>
                    <p class="withdraw-note" style="margin-top: 10px; color: var(--subtle-text);">Budget must cover the minimum 1000 clicks (10 DOGE).</p>
                </div>
                
                <div class="card">
                    <h3>Active Campaigns</h3>
                    <ul id="active-campaigns-list">
                        <p style="color:var(--subtle-text);">Loading your campaigns...</p>
                    </ul>
                </div>
            </div>
        </main>

        <nav class="bottom-nav">
            <button class="nav-btn" data-page="menu-page"><i class="fas fa-list-check"></i><span>Tasks</span></button>
            <button class="nav-btn" data-page="friends-page"><i class="fas fa-users"></i><span>Friends</span></button>
            <button class="nav-btn" data-page="withdraw-page"><i class="fas fa-wallet"></i><span>Withdraw</span></button>
            <button class="nav-btn" data-page="ad-management-page"><i class="fas fa-bullhorn"></i><span>Promote</span></button>
        </nav>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { getDatabase, ref as rtdbRef, get as rtdbGet, set as rtdbSet, update as rtdbUpdate, onValue as rtdbOnValue, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

        // LÃœTFEN KENDÄ° FIREBASE AYARLARINIZI BURAYA GÄ°RÄ°N
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyAYJqf6Y090mN4fjQAR9m7hNil7hjn0HMg",
            authDomain: "tronadsfaucet-fd451.firebaseapp.com",
            databaseURL: "https://tronadsfaucet-fd451-default-rtdb.firebaseio.com",
            projectId: "tronadsfaucet-fd451",
            storageBucket: "tronadsfaucet-fd451.appspot.com",
            messagingSenderId: "110511122993",
            appId: "1:110511122993:web:99099461844e1fbbe10310",
            measurementId: "G-VZ3Z6SFMXZ"
        };
        const ADMIN_TELEGRAM_IDS = ["7904032877", "8392479231"]; 
        
        // DOGE GÃœNCELLEMELERÄ° VE Ä°STENEN LÄ°MÄ°TLER
        const DOGE_REWARD_AMOUNT = 0.02; // Sponsored GÃ¶rev baÅŸÄ±
        const AD_REWARD_AMOUNT = 0.01; // Reklam izleme baÅŸÄ± (Ä°stenen deÄŸer)
        const AD_LIMIT = 100; // GÃ¼nlÃ¼k maksimum reklam izleme (Ä°STENEN LÄ°MÄ°T: 100)
        const AD_COOLDOWN_SECONDS = 5; // Reklam izleme cooldown (Ä°STENEN SÃœRE: 5 saniye)
        const REFERRAL_BONUS_USD = 0.005; 
        const MIN_WITHDRAW_DOGE = 5.00; // Ä°STENEN MÄ°NÄ°MUM Ã‡EKÄ°M: 5.00 DOGE
        const MAX_WITHDRAW_DOGE = 50.00; 
        const BOT_USERNAME = "DogeAdsFaucetBot"; 
        const SPONSORED_TASK_URL = "https://t.me/TKS_airdrop"; 
        
        // REKLAM YÃ–NETÄ°MÄ° SABÄ°TLERÄ°
        const MIN_AD_BUDGET_DOGE = 10.00;
        const COST_PER_CLICK_DOGE = AD_REWARD_AMOUNT;

        const SECURITY_CONFIG = {
            MAX_BALANCE_INCREASE_PER_MINUTE: 0.10, 
            SUSPICIOUS_ACTIVITY_LIMIT: 3,
            CHECK_INTERVAL: 60000
        };

        let currentDogePriceUsd = 0.16597; 
        let userUid = null;
        let telegramId = null;

        const app = initializeApp(FIREBASE_CONFIG);
        const rtdb = getDatabase(app);
        const firestore = getFirestore(app);

        const getUidFromTelegramId = (id) => `tg_user_${id}`;
        
        window.showSection = (sectionId) => {
            document.querySelectorAll('.page').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
            
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.nav-btn[data-page="${sectionId}"]`)?.classList.add('active');

            if (sectionId === 'admin-panel') {
                loadAdminPanel();
                loadBannedUsers(); 
                loadAllUsers(); 
            } else if (sectionId === 'ad-management-page') { 
                loadUserCampaigns();
            }
        }

        window.copyToClipboard = (elementId) => {
            const copyText = document.getElementById(elementId);
            const code = copyText.value;
            const fullLink = `https://t.me/${BOT_USERNAME}?start=${code}`;

            navigator.clipboard.writeText(fullLink).then(() => {
                window.Telegram.WebApp.showAlert("Referral Link copied to clipboard!");
                window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
            }).catch(err => {
                 window.Telegram.WebApp.showAlert(`Failed to copy: ${err}`);
            });
        }
        
        async function checkUserBan() {
            if (!userUid) return false;
            
            const bannedUserRef = rtdbRef(rtdb, 'banned_users/' + userUid); 
            
            const snapshot = await rtdbGet(bannedUserRef);
            if (snapshot.exists()) {
                const banData = snapshot.val();
                const banReason = banData.reason || "Multiple security violations detected (Cheat System).";
                
                document.getElementById('ban-reason-display').textContent = banReason;
                
                const bottomNav = document.querySelector('.bottom-nav');
                if (bottomNav) {
                    bottomNav.style.display = 'none';
                }
                
                document.querySelectorAll('.page').forEach(section => {
                    section.classList.remove('active');
                });
                document.getElementById('banned-screen').classList.add('active');

                window.Telegram.WebApp.showAlert(`Account suspended. Reason: ${banReason}`);
                
                return true;
            }
            return false;
        }

        async function autoBanUser(reason, userUid, telegramId) {
            const banRef = rtdbRef(rtdb, 'banned_users/' + userUid);
            const activityRef = rtdbRef(rtdb, 'suspicious_activity/' + userUid + '/' + Date.now());
            
            const banData = {
                user_id: userUid,
                telegram_id: telegramId,
                reason: reason,
                banned_at: serverTimestamp(),
                banned_by: 'AUTO_SYSTEM'
            };
            
            const activityData = {
                user_id: userUid,
                telegram_id: telegramId,
                reason: reason,
                detected_at: serverTimestamp(),
                action_taken: 'AUTO_BANNED'
            };
            
            await Promise.all([
                rtdbSet(banRef, banData),
                rtdbSet(activityRef, activityData)
            ]);
            
            const userRef = rtdbRef(rtdb, 'users/' + userUid);
            await rtdbUpdate(userRef, {
                balance_usd: 0,
                is_banned: true,
                ban_reason: reason
            });
        }

        function detectSuspiciousActivity(userData, previousData) {
            const suspiciousFlags = [];
            
            if (!previousData) return suspiciousFlags;
            
            const balanceIncrease = userData.balance_usd - (previousData.balance_usd || 0);
            if (balanceIncrease > SECURITY_CONFIG.MAX_BALANCE_INCREASE_PER_MINUTE) {
                suspiciousFlags.push(`Abnormal balance increase: $${balanceIncrease}`);
            }
            
            if (userData.balance_usd < 0) {
                suspiciousFlags.push(`Negative balance: $${userData.balance_usd}`);
            }
            
            return suspiciousFlags;
        }

        function setupSecurityMonitor() {
            if (!userUid) return;
            
            let previousUserData = null;
            
            const userRef = rtdbRef(rtdb, 'users/' + userUid);
            rtdbOnValue(userRef, async (snapshot) => {
                const currentData = snapshot.val();
                if (!currentData || !previousUserData) {
                    previousUserData = currentData;
                    return;
                }
                
                const suspiciousActivities = detectSuspiciousActivity(currentData, previousUserData);
                
                if (suspiciousActivities.length > 0) {
                    const reason = suspiciousActivities.join(' | ');
                    
                    const suspicionCount = (currentData.suspicion_count || 0) + 1;
                    await rtdbUpdate(userRef, { suspicion_count: suspicionCount });
                    
                    if (suspicionCount >= SECURITY_CONFIG.SUSPICIOUS_ACTIVITY_LIMIT) {
                        await autoBanUser(`Multiple cheat detection: ${reason}`, userUid, telegramId); 
                        window.Telegram.WebApp.showAlert("Security violation detected. Your account has been suspended.");
                        window.Telegram.WebApp.close();
                    }
                }
                
                previousUserData = currentData;
            }, {
                onlyOnce: false 
            });
        }

        function loadAllUsers() {
            const usersRef = rtdbRef(rtdb, 'users');
            const ul = document.getElementById('users-list');
            const searchTerm = document.getElementById('user-search-input').value.trim().toLowerCase(); 

            ul.innerHTML = '<p style="color:var(--subtle-text);">Loading users...</p>';
            
            rtdbOnValue(usersRef, (snapshot) => {
                ul.innerHTML = '';
                
                if (!snapshot.exists()) {
                    ul.innerHTML = '<p style="color:green;">No users found.</p>';
                    return;
                }
                
                const users = [];
                let totalSponsoredTasks = 0; 
                let totalClicks = 0; 
                let totalUserBalance = 0; // Toplam bakiye iÃ§in
                let totalReferrals = 0; // Toplam referans iÃ§in
                
                snapshot.forEach(userSnapshot => {
                    const userData = userSnapshot.val();
                    const hasCompletedTask = userData.has_completed_sponsored_task || false;
                    
                    if(hasCompletedTask) {
                        totalSponsoredTasks++;
                    }
                    totalClicks += userData.total_ads_watched || 0;
                    totalUserBalance += userData.balance_usd || 0;
                    totalReferrals += userData.referral_count || 0;

                    users.push({
                        uid: userSnapshot.key,
                        telegram_id: userData.telegram_id,
                        username: userData.username || 'N/A',
                        balance_usd: userData.balance_usd || 0,
                        completed_task: hasCompletedTask, 
                        referral_count: userData.referral_count || 0,
                        total_ads_watched: userData.total_ads_watched || 0, 
                        created_at: userData.created_at
                    });
                });
                
                document.getElementById('admin-user-count').textContent = users.length.toLocaleString();
                document.getElementById('admin-total-balance').textContent = `$${totalUserBalance.toFixed(2)}`;
                document.getElementById('admin-total-tasks').textContent = totalSponsoredTasks.toLocaleString();
                document.getElementById('admin-total-clicks').textContent = totalClicks.toLocaleString(); 
                document.getElementById('admin-total-referrals').textContent = totalReferrals.toLocaleString();

                users.sort((a, b) => b.balance_usd - a.balance_usd);
                
                let filteredCount = 0;

                users.forEach(user => {
                    const matchesSearch = searchTerm === '' || 
                                          user.telegram_id.includes(searchTerm) || 
                                          user.username.toLowerCase().includes(searchTerm) ||
                                          user.uid.toLowerCase().includes(searchTerm);
                    
                    if (matchesSearch) {
                        const li = document.createElement('li');
                        li.style.padding = '10px';
                        li.style.marginBottom = '8px';
                        li.style.border = '1px solid #ddd';
                        li.style.borderRadius = '5px';
                        li.style.backgroundColor = user.completed_task ? '#e6ffe6' : '#f9f9f9'; 
                        
                        li.innerHTML = `
                            <p><strong>User:</strong> ${user.username} (ID: ${user.telegram_id})</p>
                            <p><strong>UID:</strong> <code>${user.uid}</code></p>
                            <div class="user-stats-grid">
                                <div class="stat-item">
                                    <div>Balance</div>
                                    <div class="stat-value">$${user.balance_usd.toFixed(4)}</div>
                                </div>
                                <div class="stat-item">
                                    <div>Referrals</div>
                                    <div class="stat-value">${user.referral_count}</div>
                                </div>
                                <div class="stat-item">
                                    <div>Clicks</div>
                                    <div class="stat-value">${user.total_ads_watched}</div>
                                </div>
                                <div class="stat-item">
                                    <div>Sponsored Task</div>
                                    <div class="stat-value" style="color:${user.completed_task ? '#4CAF50' : '#f44336'};">${user.completed_task ? 'YES' : 'NO'}</div>
                                </div>
                            </div>
                            <div style="margin-top: 8px;">
                                <button onclick="manualBanUser('${user.uid}', '${user.telegram_id}')" class="reject-btn" style="padding: 5px 8px; font-size: 0.8rem;">
                                    <i class="fas fa-ban"></i> Ban User
                                </button>
                                <button onclick="viewUserDetails('${user.uid}')" class="approve-btn" style="padding: 5px 8px; font-size: 0.8rem; margin-left: 5px;">
                                    <i class="fas fa-info"></i> Details
                                </button>
                            </div>
                        `;
                        ul.appendChild(li);
                        filteredCount++;
                    }
                });

                if (filteredCount === 0) {
                    ul.innerHTML = '<p style="color:var(--primary-color);">No users found matching the criteria.</p>';
                }
            });
        }

        window.manualBanUser = (uid, telegramId = 'Unknown') => {
            if (!uid || !uid.startsWith('tg_user_')) {
                return window.Telegram.WebApp.showAlert("Invalid User UID format. Example: tg_user_12345");
            }
            
            const banRef = rtdbRef(rtdb, 'banned_users/' + uid);
            rtdbSet(banRef, {
                user_id: uid,
                telegram_id: telegramId,
                banned_at: serverTimestamp(),
                banned_by: 'Admin Manual Ban',
                reason: "Manual ban by admin"
            }).then(() => {
                window.Telegram.WebApp.showAlert(`User ${telegramId} (UID: ${uid}) banned successfully.`);
                loadBannedUsers();
            });
        };

        window.viewUserDetails = (userId) => {
            const userRef = rtdbRef(rtdb, 'users/' + userId);
            rtdbGet(userRef).then((snapshot) => {
                const userData = snapshot.val();
                if (userData) {
                    let details = `ðŸ“Š User Details:\n\n`;
                    details += `ðŸ‘¤ Username: ${userData.username}\n`;
                    details += `ðŸ†” Telegram ID: ${userData.telegram_id}\n`;
                    details += `ðŸ’° Balance: $${userData.balance_usd?.toFixed(4) || '0'}\n`;
                    details += `âœ… Sponsored Task: ${userData.has_completed_sponsored_task ? 'YES' : 'NO'}\n`;
                    details += `ðŸ“¹ Ads Watched (Today): ${userData.daily_ads_watched || 0}\n`; 
                    details += `ðŸ“¹ Ads Watched (Total): ${userData.total_ads_watched || 0}\n`; 
                    details += `ðŸ‘¥ Referrals: ${userData.referral_count || '0'}\n`;
                    details += `ðŸ¤ Referred by: ${userData.referred_by || 'None'}\n`;
                    details += `ðŸ•’ Created: ${userData.created_at ? new Date(userData.created_at).toLocaleString() : 'Unknown'}`;
                    
                    window.Telegram.WebApp.showAlert(details);
                }
            });
        };

        function loadBannedUsers() {
            const bannedRef = rtdbRef(rtdb, 'banned_users');
            const ul = document.getElementById('banned-users-list');
            ul.innerHTML = '';
            
            rtdbOnValue(bannedRef, (snapshot) => {
                ul.innerHTML = '';

                if (!snapshot.exists()) {
                    ul.innerHTML = '<p style="color:green;">No banned users.</p>';
                    return;
                }
                
                snapshot.forEach(userSnapshot => {
                    const banData = userSnapshot.val();
                    const li = document.createElement('li');
                    li.style.backgroundColor = '#f9e8e8'; 
                    li.style.border = '1px solid #ffaaaa';

                    li.innerHTML = `
                        <p><strong>Telegram ID:</strong> ${banData.telegram_id || 'Unknown'}</p>
                        <p><strong>UID:</strong> ${banData.user_id}</p>
                        <p><strong>Reason:</strong> ${banData.reason}</p>
                        <p><strong>Banned by:</strong> ${banData.banned_by}</p>
                        <p><strong>Date:</strong> ${new Date(banData.banned_at).toLocaleString()}</p>
                        <button onclick="manualUnbanUserByKey('${userSnapshot.key}')" class="approve-btn" style="background-color:#5cb85c;">Unban</button>
                    `;
                    ul.appendChild(li);
                });
            });
        }

        window.manualUnbanUserByKey = async (userKey) => {
            const banRef = rtdbRef(rtdb, 'banned_users/' + userKey);
            await rtdbSet(banRef, null);
            window.Telegram.WebApp.showAlert("User unbanned successfully.");
            loadBannedUsers();
        };

        function loadAdminPanel() {
            // Firestore Ã§ekim istekleri
            const requestsCollection = collection(firestore, "withdrawal_requests");
            const pendingQuery = query(requestsCollection, where("status", "==", "Pending"));
            const ul = document.getElementById('withdrawal-list');
            
            ul.innerHTML = '<p style="color:var(--subtle-text);">Loading pending requests...</p>';

            onSnapshot(pendingQuery, (querySnapshot) => {
                ul.innerHTML = '';
                
                if (querySnapshot.empty) {
                    ul.innerHTML = '<p style="color:#4CAF50;">No pending withdrawal requests.</p>';
                    return;
                }

                querySnapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    const li = document.createElement('li');
                    
                    li.innerHTML = `
                        <p><strong>User:</strong> ${data.username} (TG ID: ${data.telegram_id})</p>
                        <p><strong>Amount:</strong> <span style="color:#007bff; font-weight:700;">${data.amount_doge} DOGE</span> (â‰ˆ $${data.amount_usd})</p>
                        <p><strong>Address:</strong> <code>${data.doge_address}</code></p>
                        <div style="margin-top: 10px;">
                            <button onclick="updateWithdrawalStatus('${docSnap.id}', 'Completed', '${data.telegram_id}', '${data.amount_doge}')" class="approve-btn">
                                <i class="fas fa-check"></i> Approve & Paid
                            </button>
                            <button onclick="updateWithdrawalStatus('${docSnap.id}', 'Rejected', '${data.telegram_id}', '${data.amount_doge}')" class="reject-btn" style="margin-left: 5px;">
                                <i class="fas fa-times"></i> Reject
                            </button>
                            <button onclick="updateWithdrawalStatus('${docSnap.id}', 'Refunded', '${data.telegram_id}', '${data.amount_doge}')" class="orange-btn" style="margin-left: 5px;">
                                <i class="fas fa-undo"></i> Refund
                            </button>
                        </div>
                    `;
                    ul.appendChild(li);
                });
            }, (error) => {
                ul.innerHTML = `<p style="color:red;">Error loading requests: ${error.message}</p>`;
            });
        }
        
        window.updateWithdrawalStatus = async (docId, status, telegramId, amountDoge) => {
            const docRef = doc(firestore, "withdrawal_requests", docId);
            
            try {
                await updateDoc(docRef, { status: status, processed_at: serverTimestamp() });
                
                if (status === 'Refunded') {
                    // Refah durumunda kullanÄ±cÄ± bakiyesini geri yÃ¼kle
                    const userUidToRefund = getUidFromTelegramId(telegramId);
                    const userRef = rtdbRef(rtdb, 'users/' + userUidToRefund);
                    const snapshot = await rtdbGet(userRef);
                    
                    if (snapshot.exists()) {
                         // USD olarak geri yÃ¼kle
                        const amountUsd = parseFloat(amountDoge) * currentDogePriceUsd; 
                        const userData = snapshot.val();
                        const newBalance = (userData.balance_usd || 0) + amountUsd;
                        await rtdbUpdate(userRef, { balance_usd: newBalance });
                        window.Telegram.WebApp.showAlert(`Request ${docId} set to ${status}. ${amountDoge} DOGE refunded to user ${telegramId}.`);
                    } else {
                        window.Telegram.WebApp.showAlert(`Request ${docId} set to ${status}. Could not find user to refund.`);
                    }
                } else {
                    window.Telegram.WebApp.showAlert(`Request ${docId} set to ${status}.`);
                }
                
            } catch (error) {
                window.Telegram.WebApp.showAlert(`Error processing request: ${error.message}`);
            }
        };

        async function fetchDogePrice() {
            try {
                // DOGE FiyatÄ±nÄ± Ã§ek
                const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=dogecoin&vs_currencies=usd');
                const data = await response.json();
                currentDogePriceUsd = data.dogecoin.usd;
                document.getElementById('current-doge-price').textContent = currentDogePriceUsd.toFixed(4);
            } catch (error) {
                // Hata durumunda sabit bir fiyata fallback yap
                currentDogePriceUsd = 0.16597; 
                document.getElementById('current-doge-price').textContent = `F: ${currentDogePriceUsd.toFixed(4)}`;
            }
        }
        
        // REKLAM Cooldown ve Limit KontrolÃ¼
        function checkAdCooldown(userData) {
            const dailyAdsWatched = userData.daily_ads_watched || 0;
            const lastAdWatch = userData.last_ad_watch || 0;
            const now = Date.now();

            if (dailyAdsWatched >= AD_LIMIT) {
                return { canWatch: false, statusMessage: `Daily limit reached (${AD_LIMIT}/${AD_LIMIT})` };
            }

            const cooldownTime = lastAdWatch + (AD_COOLDOWN_SECONDS * 1000);
            if (now < cooldownTime) {
                const remainingSeconds = Math.ceil((cooldownTime - now) / 1000);
                return { canWatch: false, statusMessage: `Cooldown: ${remainingSeconds}s` };
            }

            return { canWatch: true, statusMessage: `Ready! (${dailyAdsWatched}/${AD_LIMIT})` };
        }


        function setupUserListener() {
            if (!userUid) return;
            
            const userRef = rtdbRef(rtdb, 'users/' + userUid); 
            
            rtdbOnValue(userRef, (snapshot) => {
                let userData = snapshot.val();
                
                if (!snapshot.exists()) {
                    // KullanÄ±cÄ± verisi yoksa, yeni kullanÄ±cÄ± kaydÄ± yap
                    const tg = window.Telegram.WebApp.initDataUnsafe;
                    const username = tg.user.username || "AnonUser";
                    const initialData = {
                        telegram_id: telegramId,
                        username: username,
                        balance_usd: 0.0,
                        referral_code: telegramId,
                        referred_by: 'None',
                        created_at: Date.now(),
                        last_ad_reset: Date.now(),
                        daily_ads_watched: 0,
                        total_ads_watched: 0,
                        has_completed_sponsored_task: false,
                        referral_count: 0
                    };
                    
                    // EÄŸer bir referans kodu ile geldiyse, bu kodu iÅŸle
                    const startParam = new URLSearchParams(window.Telegram.WebApp.initData).get('start');
                    if (startParam && startParam !== telegramId) {
                        initialData.referred_by = startParam;
                    }
                    
                    rtdbSet(userRef, initialData).then(() => {
                        window.Telegram.WebApp.showAlert("Welcome! Your account has been initialized.");
                        setupUserListener(); // Dinleyiciyi yeniden baÅŸlat
                    }).catch(e => {
                        window.Telegram.WebApp.showAlert(`Initialization Error: ${e.message}`);
                    });

                    return;
                }
                
                // GÃœNLÃœK REKLAM Ä°ZLEME SIFIRLAMASI
                const lastAdReset = userData.last_ad_reset || 0;
                const now = Date.now();
                const oneDay = 24 * 60 * 60 * 1000;
                
                if (now - lastAdReset > oneDay) {
                    rtdbUpdate(userRef, {
                        daily_ads_watched: 0,
                        last_ad_reset: now 
                    });
                    return; 
                }
                
                // DOGE DÃ–NÃœÅžÃœMÃœ
                const balanceUsd = userData.balance_usd || 0.0;
                const balanceDoge = currentDogePriceUsd > 0 ? (balanceUsd / currentDogePriceUsd) : 0; 
                const referralCount = userData.referral_count || 0;
                const hasCompletedTask = userData.has_completed_sponsored_task || false;

                document.getElementById('menu-balance-doge').textContent = balanceDoge.toFixed(4);
                document.getElementById('menu-balance-usd').textContent = balanceUsd.toFixed(2);
                document.getElementById('withdraw-balance-doge').textContent = balanceDoge.toFixed(4);
                
                document.getElementById('referral-count-display').textContent = referralCount;

                document.getElementById('referral-code-input').value = userData.referral_code;

                if (userData.referred_by && userData.referred_by !== 'None') {
                    document.getElementById('enter-referrer-code').disabled = true;
                    document.getElementById('enter-referrer-code').placeholder = `Already referred by: ${userData.referred_by}`;
                    document.querySelector('#friends-page .input-group button').disabled = true;
                }

                // TEK SEFERLÄ°K GÃ–REV KONTROLÃœ
                const taskBtn = document.getElementById('sponsored-task-btn');
                const taskStatus = document.getElementById('task-status');

                if (hasCompletedTask) {
                    taskBtn.disabled = true;
                    taskBtn.textContent = 'Task Completed!';
                    taskBtn.classList.add('loading');
                    taskBtn.style.backgroundColor = '#4CAF50';
                    taskBtn.style.color = 'white';
                    taskStatus.innerHTML = 'Status: <strong style="color:#4CAF50;">Completed!</strong>';
                } else {
                     taskBtn.disabled = false;
                     taskBtn.textContent = 'Go to Sponsored Task';
                     taskBtn.classList.remove('loading');
                     taskBtn.style.backgroundColor = 'var(--primary-color)';
                     taskBtn.style.color = 'var(--text-color)';
                     taskStatus.innerHTML = 'Status: <strong style="color:#D32F2F;">Not Completed</strong>';
                }
                
                // REKLAM Ä°ZLEME KONTROLÃœ
                const adBtn = document.getElementById('watch-ad-btn');
                const adStatus = document.getElementById('ad-status');
                const { canWatch, statusMessage } = checkAdCooldown(userData);
                
                adBtn.disabled = !canWatch;
                adBtn.style.backgroundColor = canWatch ? '#4CAF50' : '#CCCCCC';
                adStatus.innerHTML = `Status: <strong style="color:${canWatch ? '#4CAF50' : '#D32F2F'};">${statusMessage}</strong>`;
            });
        }
        
        async function getAvailableAdLink(userAdsSeen) {
            const userAdsRef = rtdbRef(rtdb, 'user_ads');
            const snapshot = await rtdbGet(userAdsRef);
            const ads = [];
            
            if (snapshot.exists()) {
                snapshot.forEach(adSnapshot => {
                    const ad = adSnapshot.val();
                    if (ad.owner_uid !== userUid && ad.status === 'Active' && ad.remaining_clicks > 0) {
                        // KullanÄ±cÄ±nÄ±n daha Ã¶nce bu reklamÄ± gÃ¶rmediÄŸinden emin ol
                        if (!userAdsSeen || !userAdsSeen[adSnapshot.key]) {
                            ads.push({ id: adSnapshot.key, ...ad });
                        }
                    }
                });
            }

            // EÄŸer kullanÄ±cÄ±larÄ±n reklamÄ± yoksa, varsayÄ±lan bir reklam gÃ¶ster
            if (ads.length === 0) {
                return { link: "https://t.me/DogeOrAdvertiseChannel", adId: null }; 
            }
            
            // Rastgele bir reklam seÃ§
            const randomAd = ads[Math.floor(Math.random() * ads.length)];
            
            return { link: randomAd.ad_link, adId: randomAd.id };
        }
        
        // REKLAM Ä°ZLEME MantÄ±ÄŸÄ±
        const handleWatchAd = () => {
            const userRef = rtdbRef(rtdb, 'users/' + userUid);
            const adBtn = document.getElementById('watch-ad-btn');
            adBtn.disabled = true;

            rtdbGet(userRef).then(async (snapshot) => {
                const userData = snapshot.val();
                
                const { canWatch } = checkAdCooldown(userData);
                if (!canWatch) {
                    adBtn.disabled = false; 
                    return window.Telegram.WebApp.showAlert("Please wait for the cooldown or check your daily limit.");
                }
                
                // 1. Reklam Bulma
                const { link: adLink, adId } = await getAvailableAdLink(userData.ads_seen || {});
                
                if (!adLink) {
                    adBtn.disabled = false; 
                    return window.Telegram.WebApp.showAlert("No ads available right now. Please try again later.");
                }
                
                // 2. 5 Saniye Bekleme SÃ¼resi (GÃ–RSEL COOLDOWN)
                adBtn.disabled = true;
                adBtn.classList.add('loading');
                adBtn.innerHTML = `<i class="fas fa-clock fa-spin" style="margin-right:10px;"></i> Waiting ${AD_COOLDOWN_SECONDS} seconds...`; 

                await new Promise(resolve => setTimeout(resolve, AD_COOLDOWN_SECONDS * 1000));
                
                adBtn.innerHTML = `<i class="fas fa-external-link-alt" style="margin-right:10px;"></i> Opening Ad...`;


                // 3. ReklamÄ± AÃ§
                window.Telegram.WebApp.openLink(adLink);

                // 4. Ã–dÃ¼l Hesaplama
                const adRewardInUsd = AD_REWARD_AMOUNT * currentDogePriceUsd;
                const newBalance = (userData.balance_usd || 0.0) + adRewardInUsd;
                
                const newAdsWatched = (userData.daily_ads_watched || 0) + 1;
                const newTotalAds = (userData.total_ads_watched || 0) + 1;
                
                // 5. KullanÄ±cÄ±yÄ± Ã¶dÃ¼llendir ve istatistikleri gÃ¼ncelle
                const updates = {
                    balance_usd: newBalance,
                    daily_ads_watched: newAdsWatched,
                    total_ads_watched: newTotalAds,
                    last_ad_watch: Date.now() 
                };
                
                if (adId) {
                    // KullanÄ±cÄ±nÄ±n bu reklamÄ± gÃ¶rdÃ¼ÄŸÃ¼nÃ¼ iÅŸaretle
                    updates[`ads_seen/${adId}`] = true;
                    
                    // Reklam sahibinin tÄ±klama sayÄ±sÄ±nÄ± ve bÃ¼tÃ§esini gÃ¼ncelle
                    const adRef = rtdbRef(rtdb, 'user_ads/' + adId);
                    const adSnapshot = await rtdbGet(adRef);
                    if (adSnapshot.exists()) {
                        await rtdbUpdate(adRef, {
                            remaining_clicks: adSnapshot.val().remaining_clicks - 1,
                            clicks: adSnapshot.val().clicks + 1,
                        });
                    }
                }
                
                return rtdbUpdate(userRef, updates).then(() => {
                    window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
                    window.Telegram.WebApp.showAlert(`Success! You earned ${AD_REWARD_AMOUNT.toFixed(2)} DOGE.`);
                });

            }).catch(e => {
                window.Telegram.WebApp.showAlert(`Ad Error: ${e.message || 'Unknown Error'}`);
            }).finally(() => {
                // UI listener otomatik olarak gÃ¼ncellenecek
                adBtn.classList.remove('loading');
                adBtn.disabled = false;
            });
        }

        // Sponsored GÃ¶rev MantÄ±ÄŸÄ±
        const handleSponsoredTaskClick = () => {
            const userRef = rtdbRef(rtdb, 'users/' + userUid);

            rtdbGet(userRef).then((snapshot) => {
                const userData = snapshot.val();
                
                if (userData?.has_completed_sponsored_task) {
                    return window.Telegram.WebApp.showAlert("This task has already been completed. It is a one-time reward.");
                }
                
                // 1. GÃ¶rev URL'sini harici olarak aÃ§
                window.Telegram.WebApp.openLink(SPONSORED_TASK_URL);
                
                // 2. Ã–dÃ¼l Hesaplama
                const dogeRewardInUsd = DOGE_REWARD_AMOUNT * currentDogePriceUsd;
                const newBalance = (userData.balance_usd || 0.0) + dogeRewardInUsd;
                
                // 3. KullanÄ±cÄ±yÄ± Ã¶dÃ¼llendir ve gÃ¶revi tamamlanmÄ±ÅŸ olarak iÅŸaretle
                return rtdbUpdate(userRef, {
                    balance_usd: newBalance,
                    has_completed_sponsored_task: true,
                    last_task_completed: serverTimestamp()
                }).then(() => {
                    window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
                    window.Telegram.WebApp.showAlert(`Success! You earned ${DOGE_REWARD_AMOUNT} DOGE for completing the sponsored task.`);
                });

            }).catch(e => {
                window.Telegram.WebApp.showAlert(`Task Error: ${e.message || 'Unknown Error'}`);
            });
        }
        
        window.applyReferralCode = async () => {
            const referrerId = document.getElementById('enter-referrer-code').value.trim();
            const userRef = rtdbRef(rtdb, 'users/' + userUid);
            const referrerUid = getUidFromTelegramId(referrerId);
            const referrerRef = rtdbRef(rtdb, 'users/' + referrerUid);
            
            if (!referrerId) {
                return window.Telegram.WebApp.showAlert("Please enter a friend's Telegram ID.");
            }
            if (referrerId === telegramId) {
                return window.Telegram.WebApp.showAlert("You cannot refer yourself!");
            }
            
            const userSnapshot = await rtdbGet(userRef);
            const userData = userSnapshot.val();
            
            if (userData.referred_by !== 'None') {
                 return window.Telegram.WebApp.showAlert("You have already used a referral code.");
            }

            const referrerSnapshot = await rtdbGet(referrerRef);
            if (!referrerSnapshot.exists()) {
                 return window.Telegram.WebApp.showAlert("Referrer not found. Please ensure the Telegram ID is correct.");
            }

            // Referans veren kiÅŸiyi gÃ¼ncelle
            const referrerData = referrerSnapshot.val();
            const newReferralCount = (referrerData.referral_count || 0) + 1;
            
            await rtdbUpdate(referrerRef, { referral_count: newReferralCount });

            // KullanÄ±cÄ±yÄ± gÃ¼ncelle ve bonusu ver
            const newBalanceUsd = (userData.balance_usd || 0.0) + REFERRAL_BONUS_USD;
            await rtdbUpdate(userRef, {
                referred_by: referrerId,
                balance_usd: newBalanceUsd 
            });

            window.Telegram.WebApp.showAlert(`Referral code applied! You earned $${REFERRAL_BONUS_USD.toFixed(4)} and your friend ${referrerId} got a bonus.`);
            document.getElementById('enter-referrer-code').disabled = true;
            document.querySelector('#friends-page .input-group button').disabled = true;
        }

        const handleWithdrawSubmit = (e) => {
            e.preventDefault();
            const withdrawSubmitBtn = document.getElementById('withdraw-submit-btn');
            
            if (!userUid || !telegramId) {
                return window.Telegram.WebApp.showAlert("Withdrawal failed: User session not loaded. Please restart the bot.");
            }

            const userRef = rtdbRef(rtdb, 'users/' + userUid);
            const dogeAddress = document.getElementById('doge-address').value.trim();
            const amountInDoge = parseFloat(document.getElementById('amount-doge').value);
            
            if (!dogeAddress || dogeAddress.length < 34) {
                return window.Telegram.WebApp.showAlert("Please enter a valid DOGE address (starts with 'D' or has a correct format).");
            }
            if (isNaN(amountInDoge) || amountInDoge <= 0) {
                return window.Telegram.WebApp.showAlert("Please enter a valid amount in DOGE.");
            }
            
            // MÄ°NÄ°MUM Ã‡EKÄ°M LÄ°MÄ°TÄ° KONTROLÃœ (5 DOGE)
            if (amountInDoge < MIN_WITHDRAW_DOGE) {
                return window.Telegram.WebApp.showAlert(`Withdrawal failed: Minimum withdrawal is ${MIN_WITHDRAW_DOGE.toFixed(2)} DOGE.`);
            }

            if (amountInDoge > MAX_WITHDRAW_DOGE) {
                return window.Telegram.WebApp.showAlert(`Withdrawal failed: Maximum withdrawal is ${MAX_WITHDRAW_DOGE.toFixed(2)} DOGE.`);
            }
            
            const withdrawUsdAmount = amountInDoge * currentDogePriceUsd;

            withdrawSubmitBtn.disabled = true;

            rtdbGet(userRef).then(snapshot => {
                const userData = snapshot.val();
                
                if (!userData) {
                    throw new Error("User data is missing on Firebase.");
                }
                
                const usdBalance = userData.balance_usd || 0.0;
                
                if (withdrawUsdAmount > usdBalance) {
                    const dogeBalance = currentDogePriceUsd > 0 ? (usdBalance / currentDogePriceUsd) : 0; 
                    withdrawSubmitBtn.disabled = false;
                    return window.Telegram.WebApp.showAlert(`Withdrawal failed: Insufficient balance. Available DOGE: ${dogeBalance.toFixed(4)}`);
                }

                const newUsdBalance = usdBalance - withdrawUsdAmount;

                const requestsCollection = collection(firestore, "withdrawal_requests");
                
                return addDoc(requestsCollection, {
                    user_id: userUid,
                    telegram_id: telegramId,
                    username: userData.username,
                    doge_address: dogeAddress, 
                    amount_usd: withdrawUsdAmount.toFixed(4),
                    amount_doge: amountInDoge.toFixed(4),
                    status: "Pending", 
                    timestamp: serverTimestamp()
                }).then(() => {
                    return rtdbUpdate(userRef, { balance_usd: newUsdBalance });
                });
                
            }).then(() => {
                window.Telegram.WebApp.showAlert(`Withdrawal request for ${amountInDoge.toFixed(4)} DOGE submitted successfully. Your request is now pending admin approval.`);
                document.getElementById('amount-doge').value = '';
                document.getElementById('withdraw-usd-amount').textContent = '$0.00';
            }).catch(e => {
                let errorMessage = "An error occurred during withdrawal. Please try again later.";
                
                if (e.message && e.message.includes("User data is missing")) {
                    errorMessage = "User data could not be initialized. Please restart the bot and try again.";
                } else if (e.code && e.code.includes("permission-denied")) {
                    errorMessage = "Withdrawal failed: Database permission denied. Please check your Firebase Rules.";
                } else if (e.message && e.message.includes("Failed to fetch")) {
                    errorMessage = "Network error: Failed to connect to Firebase. Check your internet.";
                }
                
                window.Telegram.WebApp.showAlert(`Withdrawal failed: ${errorMessage}`);
            }).finally(() => {
                withdrawSubmitBtn.disabled = false;
            });
        }
        
        // KullanÄ±cÄ± KampanyasÄ± OluÅŸturma
        async function handleCreateCampaign() {
            const link = document.getElementById('ad-link').value.trim();
            const budgetDoge = parseFloat(document.getElementById('ad-budget-doge').value);
            const createBtn = document.getElementById('create-ad-btn');

            if (!link || !link.startsWith('https://t.me/')) {
                return window.Telegram.WebApp.showAlert("Invalid link. Please use a Telegram link (e.g., https://t.me/YourChannel).");
            }
            if (isNaN(budgetDoge) || budgetDoge < MIN_AD_BUDGET_DOGE) {
                return window.Telegram.WebApp.showAlert(`Minimum budget is ${MIN_AD_BUDGET_DOGE.toFixed(2)} DOGE.`);
            }
            
            createBtn.disabled = true;

            const userRef = rtdbRef(rtdb, 'users/' + userUid);
            rtdbGet(userRef).then(async (snapshot) => {
                const userData = snapshot.val();
                const balanceUsd = userData.balance_usd || 0.0;
                
                const budgetUsd = budgetDoge * currentDogePriceUsd;
                
                if (budgetUsd > balanceUsd) {
                    createBtn.disabled = false;
                    return window.Telegram.WebApp.showAlert(`Insufficient balance! You need ${budgetDoge.toFixed(2)} DOGE but only have ${(balanceUsd / currentDogePriceUsd).toFixed(2)} DOGE.`);
                }
                
                const newBalanceUsd = balanceUsd - budgetUsd;
                
                const clicksCount = Math.floor(budgetDoge / COST_PER_CLICK_DOGE);

                const adRef = rtdbRef(rtdb, 'user_ads/' + userUid + '_' + Date.now()); 
                
                await rtdbSet(adRef, {
                    owner_uid: userUid,
                    owner_tg_id: telegramId,
                    ad_link: link,
                    initial_budget_doge: budgetDoge.toFixed(2),
                    cost_per_click_doge: COST_PER_CLICK_DOGE.toFixed(2),
                    remaining_clicks: clicksCount,
                    total_clicks: 0,
                    clicks: 0,
                    status: 'Active', 
                    created_at: serverTimestamp(),
                });
                
                await rtdbUpdate(userRef, {
                    balance_usd: newBalanceUsd 
                });

                window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
                window.Telegram.WebApp.showAlert(`Campaign created successfully! ${budgetDoge.toFixed(2)} DOGE deducted from your balance. Your ad will receive ${clicksCount} clicks.`);
                
                document.getElementById('ad-link').value = '';
                document.getElementById('ad-budget-doge').value = '';
                
            }).catch(e => {
                window.Telegram.WebApp.showAlert(`Campaign Creation Failed: ${e.message || 'Unknown Error'}`);
            }).finally(() => {
                createBtn.disabled = false;
            });
        }
        
        // KullanÄ±cÄ±nÄ±n kampanyalarÄ±nÄ± yÃ¼kle
        function loadUserCampaigns() {
            const adsRef = rtdbRef(rtdb, 'user_ads');
            const ul = document.getElementById('active-campaigns-list');
            ul.innerHTML = '<p style="color:var(--subtle-text);">Loading your campaigns...</p>';
            
            rtdbOnValue(adsRef, (snapshot) => {
                ul.innerHTML = '';
                let foundCampaigns = false;
                
                snapshot.forEach(adSnapshot => {
                    const ad = adSnapshot.val();
                    if (ad.owner_uid === userUid) {
                        foundCampaigns = true;
                        
                        const li = document.createElement('li');
                        li.style.padding = '10px';
                        li.style.marginBottom = '8px';
                        li.style.border = `1px solid ${ad.status === 'Active' ? '#4CAF50' : '#D32F2F'}`;
                        li.style.borderRadius = '5px';
                        li.style.backgroundColor = '#f9f9f9';
                        
                        const remainingBudget = (ad.remaining_clicks || 0) * COST_PER_CLICK_DOGE;
                        
                        li.innerHTML = `
                            <p><strong>Link:</strong> <a href="${ad.ad_link}" target="_blank">${ad.ad_link.substring(0, 30)}...</a></p>
                            <p><strong>Status:</strong> <span style="font-weight:700; color:${ad.status === 'Active' ? '#4CAF50' : '#D32F2F'};">${ad.status}</span></p>
                            <p><strong>Total Clicks:</strong> ${ad.clicks || 0}</p>
                            <p><strong>Remaining Clicks:</strong> ${ad.remaining_clicks || 0}</p>
                            <p><strong>Remaining Budget:</strong> ${remainingBudget.toFixed(2)} DOGE</p>
                        `;
                        ul.appendChild(li);
                    }
                });

                if (!foundCampaigns) {
                    ul.innerHTML = '<p style="color:var(--subtle-text);">You have no active campaigns.</p>';
                }
            });
        }

        function setupEventListeners() {
            document.getElementById('sponsored-task-btn').addEventListener('click', handleSponsoredTaskClick);
            document.getElementById('watch-ad-btn').addEventListener('click', handleWatchAd); 
            document.getElementById('create-ad-btn').addEventListener('click', handleCreateCampaign); 
            document.getElementById('withdraw-form').addEventListener('submit', handleWithdrawSubmit);
            
            document.getElementById('amount-doge').addEventListener('input', () => {
                const doge = parseFloat(document.getElementById('amount-doge').value);
                const withdrawUsd = document.getElementById('withdraw-usd-amount');
                if (isNaN(doge) || doge <= 0 || currentDogePriceUsd === 0) {
                    withdrawUsd.textContent = '$0.00';
                } else {
                    withdrawUsd.textContent = `$${(doge * currentDogePriceUsd).toFixed(4)}`;
                }
            });

            document.getElementById('ad-budget-doge').addEventListener('input', () => {
                 const doge = parseFloat(document.getElementById('ad-budget-doge').value);
                 const clicks = document.querySelector('#ad-management-page .card p.withdraw-note');
                 if (isNaN(doge) || doge <= 0) {
                    clicks.textContent = `Budget must cover the minimum 1000 clicks (10 DOGE).`;
                 } else {
                    const clicksCount = Math.floor(doge / COST_PER_CLICK_DOGE);
                    clicks.textContent = `This budget gives you approximately ${clicksCount.toLocaleString()} clicks (1 Click = ${COST_PER_CLICK_DOGE.toFixed(2)} DOGE).`;
                 }
            });

            const navButtons = document.querySelectorAll('.bottom-nav .nav-btn');
            navButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const pageId = button.dataset.page;
                    window.showSection(pageId); 
                });
            });
        }

        const initApp = async () => {
            const tg = window.Telegram.WebApp;
            tg.ready();
            tg.expand();
            
            const user = tg.initDataUnsafe.user;
            if (!user || !user.id) {
                tg.showAlert("Could not verify user. Please open this app through Telegram.", () => tg.close());
                return;
            }
            
            telegramId = user.id.toString();
            userUid = getUidFromTelegramId(telegramId);
            
            const referralInput = document.getElementById('referral-code-input');
            if (referralInput) {
                referralInput.value = telegramId;
                referralInput.placeholder = telegramId;
            }

            if (ADMIN_TELEGRAM_IDS.includes(telegramId)) {
                document.getElementById('admin-indicator').style.display = 'block';
                const nav = document.querySelector('.bottom-nav');
                if (!document.querySelector('.nav-btn[data-page="admin-panel"]')) {
                    const adminBtn = document.createElement('button');
                    adminBtn.className = 'nav-btn';
                    adminBtn.dataset.page = 'admin-panel';
                    adminBtn.innerHTML = '<i class="fas fa-user-shield"></i><span>Admin</span>';
                    adminBtn.addEventListener('click', () => showSection('admin-panel')); 
                    nav.appendChild(adminBtn);
                }
            }
            
            const isBanned = await checkUserBan();
            if (isBanned) {
                return;
            }
            
            await fetchDogePrice(); 
            setupUserListener();
            setupEventListeners();
            setupSecurityMonitor();
            
            // Limitleri ve Ã¶dÃ¼lleri gÃ¶ster
            document.getElementById('min-withdraw-display').textContent = MIN_WITHDRAW_DOGE.toFixed(2);
            document.getElementById('max-withdraw-display').textContent = MAX_WITHDRAW_DOGE.toFixed(2);
            document.getElementById('task-reward-doge').textContent = DOGE_REWARD_AMOUNT.toFixed(2);
            document.getElementById('ad-reward-doge').textContent = AD_REWARD_AMOUNT.toFixed(2);
            document.getElementById('cpc-doge').textContent = COST_PER_CLICK_DOGE.toFixed(2);
            
            showSection('menu-page'); 
        };
        
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
